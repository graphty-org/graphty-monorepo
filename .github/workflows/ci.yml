name: CI

on:
  push:
    branches: [master]
  pull_request:

# Note: We use local Nx caching only (no Nx Cloud)
# Cache is stored in .nx/cache and persisted via actions/cache

jobs:
  # Lint PR titles with commitlint
  lint-pr:
    name: Lint PR Title
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Lint PR title
        run: echo "${{ github.event.pull_request.title }}" | pnpm exec commitlint

  # Build job - runs once, shares artifacts with test shards
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-build-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-build-${{ hashFiles('pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-build-

      # PR: Lint and build only affected
      - name: Lint affected (PR)
        if: github.event_name == 'pull_request'
        run: pnpm exec nx affected -t lint --parallel=3

      - name: Build affected (PR)
        if: github.event_name == 'pull_request'
        run: pnpm exec nx affected -t build --parallel=3

      # Master: Lint and build all
      - name: Lint all (master)
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: pnpm exec nx run-many -t lint --parallel=3

      - name: Build all (master)
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: pnpm exec nx run-many -t build --parallel=3

      - name: Build Storybook
        run: pnpm exec nx run graphty-element:build-storybook

      - name: Upload algorithms build
        uses: actions/upload-artifact@v4
        with:
          name: build-algorithms
          path: algorithms/dist/
          retention-days: 1

      - name: Upload layout build
        uses: actions/upload-artifact@v4
        with:
          name: build-layout
          path: layout/dist/
          retention-days: 1

      - name: Upload graphty build
        uses: actions/upload-artifact@v4
        with:
          name: build-graphty
          path: graphty/dist/
          retention-days: 1

      - name: Upload graphty-element build
        uses: actions/upload-artifact@v4
        with:
          name: build-graphty-element
          path: graphty-element/dist/
          retention-days: 1

      - name: Upload Storybook build
        uses: actions/upload-artifact@v4
        with:
          name: build-storybook
          path: graphty-element/storybook-static/
          retention-days: 1

  # Sharded test jobs - run in parallel, collect coverage
  test:
    name: Test (${{ matrix.shard }})
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard:
          - algorithms
          - layout
          - graphty
          - graphty-element-default
          - graphty-element-browser-1
          - graphty-element-browser-2
          - graphty-element-browser-3
          - graphty-element-browser-4
          - graphty-element-browser-5
          - graphty-element-storybook-1
          - graphty-element-storybook-2
          - graphty-element-storybook-3
          - graphty-element-storybook-4
        include:
          # algorithms - single shard
          - shard: algorithms
            package: algorithms
            test-command: pnpm exec nx run algorithms:test --ci --coverage
            needs-browser: false
            needs-storybook: false
          # layout - single shard
          - shard: layout
            package: layout
            test-command: pnpm exec nx run layout:test --ci --coverage
            needs-browser: false
            needs-storybook: false
          # graphty - single shard
          - shard: graphty
            package: graphty
            test-command: pnpm exec nx run graphty:test --ci --coverage
            needs-browser: false
            needs-storybook: false
          # graphty-element default tests (Node.js, no browser)
          - shard: graphty-element-default
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=default --reporter=blob --coverage
            needs-browser: false
            needs-storybook: false
          # graphty-element browser tests (5 shards)
          - shard: graphty-element-browser-1
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=browser --project=interactions --shard=1/5 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: false
          - shard: graphty-element-browser-2
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=browser --project=interactions --shard=2/5 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: false
          - shard: graphty-element-browser-3
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=browser --project=interactions --shard=3/5 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: false
          - shard: graphty-element-browser-4
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=browser --project=interactions --shard=4/5 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: false
          - shard: graphty-element-browser-5
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=browser --project=interactions --shard=5/5 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: false
          # graphty-element storybook tests (4 shards)
          - shard: graphty-element-storybook-1
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=storybook --shard=1/4 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: true
          - shard: graphty-element-storybook-2
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=storybook --shard=2/4 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: true
          - shard: graphty-element-storybook-3
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=storybook --shard=3/4 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: true
          - shard: graphty-element-storybook-4
            package: graphty-element
            test-command: cd graphty-element && pnpm exec vitest run --project=storybook --shard=4/4 --reporter=blob --coverage
            needs-browser: true
            needs-storybook: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Download algorithms build
        uses: actions/download-artifact@v4
        with:
          name: build-algorithms
          path: algorithms/dist/

      - name: Download layout build
        uses: actions/download-artifact@v4
        with:
          name: build-layout
          path: layout/dist/

      - name: Download graphty build
        uses: actions/download-artifact@v4
        with:
          name: build-graphty
          path: graphty/dist/

      - name: Download graphty-element build
        uses: actions/download-artifact@v4
        with:
          name: build-graphty-element
          path: graphty-element/dist/

      - name: Download Storybook build
        if: matrix.needs-storybook
        uses: actions/download-artifact@v4
        with:
          name: build-storybook
          path: graphty-element/storybook-static/

      - name: Cache Playwright browsers
        if: matrix.needs-browser
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: matrix.needs-browser && steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Install Playwright deps (if cached)
        if: matrix.needs-browser && steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Start Storybook server
        if: matrix.needs-storybook
        run: |
          pnpm exec http-server graphty-element/storybook-static -p 9026 &
          sleep 3

      - name: Run tests
        run: ${{ matrix.test-command }}

      - name: Upload blob report
        if: ${{ !cancelled() && startsWith(matrix.shard, 'graphty-element') }}
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: graphty-element/.vitest-reports/*
          include-hidden-files: true
          retention-days: 1
          if-no-files-found: ignore

      - name: Upload coverage (graphty-element)
        if: ${{ !cancelled() && startsWith(matrix.shard, 'graphty-element') }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.shard }}
          path: graphty-element/coverage/lcov.info
          retention-days: 1
          if-no-files-found: ignore

      - name: Upload coverage (algorithms/layout/graphty)
        if: ${{ !cancelled() && (matrix.shard == 'algorithms' || matrix.shard == 'layout' || matrix.shard == 'graphty') }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.shard }}
          path: ${{ matrix.package }}/coverage/lcov.info
          retention-days: 1
          if-no-files-found: ignore

  # Merge blob reports from graphty-element shards
  merge-reports:
    name: Merge Test Reports
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Download all blob reports
        uses: actions/download-artifact@v4
        with:
          pattern: blob-report-*
          path: graphty-element/.vitest-reports
          merge-multiple: true

      - name: Merge test reports
        run: cd graphty-element && pnpm exec vitest --merge-reports || true

  # Chromatic visual regression testing
  chromatic:
    name: Chromatic Visual Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Download Storybook build
        uses: actions/download-artifact@v4
        with:
          name: build-storybook
          path: graphty-element/storybook-static/

      - name: Run Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          storybookBuildDir: ./graphty-element/storybook-static
          exitZeroOnChanges: true
          autoAcceptChanges: master
          onlyChanged: true
          externals: |
            - 'public/**'

  # Merge and publish coverage to Coveralls
  coverage:
    name: Publish Coverage
    needs: [test, merge-reports]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push' && needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports
          merge-multiple: true

      - name: Merge coverage reports
        run: |
          mkdir -p coverage
          # Find and concatenate all lcov.info files
          find coverage-reports -name 'lcov.info' -exec cat {} + > coverage/lcov.info 2>/dev/null || true
          if [ -f coverage/lcov.info ]; then
            echo "Merged coverage from all shards:"
            echo "  Lines: $(wc -l < coverage/lcov.info)"
            echo "  Files found: $(find coverage-reports -name 'lcov.info' | wc -l)"
          else
            echo "No coverage files found"
            exit 0
          fi

      - name: Publish to Coveralls
        if: hashFiles('coverage/lcov.info') != ''
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: coverage/lcov.info

  # Performance regression tests (algorithms only, master branch)
  performance:
    name: Performance Tests
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Download algorithms build
        uses: actions/download-artifact@v4
        with:
          name: build-algorithms
          path: algorithms/dist/

      - name: Download performance baseline
        uses: actions/download-artifact@v4
        with:
          name: performance-baseline
          path: algorithms/test/
        continue-on-error: true

      - name: Run performance regression tests
        run: pnpm exec nx run algorithms:benchmark
        env:
          CI: 'true'
          NODE_OPTIONS: '--max-old-space-size=8192 --expose-gc'

      - name: Upload performance baseline
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: algorithms/test/performance-baseline.json
          retention-days: 90
          if-no-files-found: ignore

  # Gate job - ensures all required checks pass before release/deploy
  all-checks:
    name: All Checks Pass
    needs: [test, chromatic, merge-reports]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Test job failed"
            exit 1
          fi
          if [[ "${{ needs.chromatic.result }}" != "success" ]]; then
            echo "Chromatic job failed"
            exit 1
          fi
          echo "All checks passed!"
