name: CI

on:
  push:
    branches: [master]
  pull_request:

# Note: We use local Nx caching only (no Nx Cloud)
# Cache is stored in .nx/cache and persisted via actions/cache

jobs:
  # Lint PR titles with commitlint
  lint-pr:
    name: Lint PR Title
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Lint PR title
        run: echo "${{ github.event.pull_request.title }}" | pnpm exec commitlint

  # Main test job
  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-${{ matrix.node-version }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium --with-deps

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Lint affected
        run: pnpm exec nx affected -t lint --parallel=3

      - name: Test affected
        run: pnpm exec nx affected -t test --parallel=3 --ci

      - name: Build affected
        run: pnpm exec nx affected -t build --parallel=3

      # Coverage only on Node 20
      - name: Run coverage tests
        if: matrix.node-version == '20.x'
        run: pnpm exec nx run-many -t test:coverage --parallel=1 --projects=algorithms,layout,graphty-element

      - name: Upload coverage artifacts
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.node-version }}
          path: |
            algorithms/coverage/lcov.info
            layout/coverage/lcov.info
            graphty-element/coverage/lcov.info
          retention-days: 1
          if-no-files-found: ignore

  # Chromatic visual regression testing
  chromatic:
    name: Chromatic Visual Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-chromatic-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-chromatic-${{ hashFiles('pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-chromatic-

      - name: Build graphty-element
        run: pnpm exec nx run graphty-element:build

      - name: Build Storybook
        run: pnpm exec nx run graphty-element:build-storybook

      - name: Run Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          storybookBuildDir: ./graphty-element/storybook-static
          exitZeroOnChanges: true
          autoAcceptChanges: master
          onlyChanged: true
          externals: |
            - 'public/**'

  # Merge and publish coverage to Coveralls
  coverage:
    name: Publish Coverage
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports
          merge-multiple: true

      - name: Merge coverage reports
        run: |
          mkdir -p coverage
          # Find and concatenate all lcov.info files
          find coverage-reports -name 'lcov.info' -exec cat {} + > coverage/lcov.info 2>/dev/null || true
          if [ -f coverage/lcov.info ]; then
            echo "Merged coverage: $(wc -l < coverage/lcov.info) lines"
          else
            echo "No coverage files found"
            exit 0
          fi

      - name: Publish to Coveralls
        if: hashFiles('coverage/lcov.info') != ''
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: coverage/lcov.info

  # Performance regression tests (algorithms only, master branch)
  performance:
    name: Performance Tests
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-perf-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-perf-${{ hashFiles('pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-perf-

      - name: Build algorithms
        run: pnpm exec nx run algorithms:build

      - name: Download performance baseline
        uses: actions/download-artifact@v4
        with:
          name: performance-baseline
          path: algorithms/test/
        continue-on-error: true

      - name: Run performance regression tests
        run: pnpm exec nx run algorithms:benchmark
        env:
          CI: 'true'
          NODE_OPTIONS: '--max-old-space-size=8192 --expose-gc'

      - name: Upload performance baseline
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: algorithms/test/performance-baseline.json
          retention-days: 90
          if-no-files-found: ignore

  # Gate job - ensures all required checks pass before release/deploy
  all-checks:
    name: All Checks Pass
    needs: [test, chromatic]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Test job failed"
            exit 1
          fi
          if [[ "${{ needs.chromatic.result }}" != "success" ]]; then
            echo "Chromatic job failed"
            exit 1
          fi
          echo "All checks passed!"
