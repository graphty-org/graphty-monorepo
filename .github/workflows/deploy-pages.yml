name: Deploy to GitHub Pages

on:
    workflow_run:
        workflows: ["CI"]
        types: [completed]
        branches: [master]
    # Manual trigger not supported - artifacts only available from CI workflow
    # To redeploy, re-run the CI workflow on master instead

permissions:
    contents: read
    pages: write
    id-token: write
    actions: read # Required to download artifacts from other workflow runs

concurrency:
    group: "pages"
    cancel-in-progress: false

jobs:
    build:
        name: Assemble Site
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            # Download all artifacts from CI workflow
            - name: Download graphty app build
              uses: actions/download-artifact@v4
              with:
                  name: build-graphty
                  path: ./graphty/dist/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download graphty-element Storybook
              uses: actions/download-artifact@v4
              with:
                  name: build-storybook-element
                  path: ./graphty-element/storybook-static/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download graphty Storybook
              uses: actions/download-artifact@v4
              with:
                  name: build-storybook-app
                  path: ./graphty/storybook-static/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download algorithms Storybook
              uses: actions/download-artifact@v4
              with:
                  name: build-storybook-algorithms
                  path: ./algorithms/storybook-static/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download layout Storybook
              uses: actions/download-artifact@v4
              with:
                  name: build-storybook-layout
                  path: ./layout/storybook-static/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download unified docs
              uses: actions/download-artifact@v4
              with:
                  name: build-docs
                  path: ./docs/.vitepress/dist/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download algorithms gh-pages
              uses: actions/download-artifact@v4
              with:
                  name: build-ghpages-algorithms
                  path: ./algorithms/gh-pages/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Download layout gh-pages
              uses: actions/download-artifact@v4
              with:
                  name: build-ghpages-layout
                  path: ./layout/gh-pages/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            # Assemble the unified GitHub Pages site
            # URL Structure:
            #   / = graphty app (React app - graphty.app)
            #   /docs/ = unified documentation (VitePress)
            #   /docs/graphty/ = graphty-element docs
            #   /docs/algorithms/ = algorithms docs
            #   /docs/layout/ = layout docs
            #   /storybook/ = Storybook index page
            #   /storybook/element/ = graphty-element Storybook
            #   /storybook/app/ = graphty Storybook
            #   /storybook/algorithms/ = algorithms Storybook
            #   /storybook/layout/ = layout Storybook
            #   /algorithms/ = algorithms gh-pages (examples + benchmarks)
            #   /layout/ = layout gh-pages (examples)
            - name: Assemble GitHub Pages site
              run: |
                  mkdir -p ./public

                  # graphty app as root (/)
                  if [ -d "./graphty/dist" ]; then
                    cp -r ./graphty/dist/* ./public/
                    echo "‚úÖ Copied graphty app to /"
                  else
                    echo "‚ö†Ô∏è graphty dist not found"
                  fi

                  # Unified docs (/docs/)
                  if [ -d "./docs/.vitepress/dist" ]; then
                    mkdir -p ./public/docs
                    cp -r ./docs/.vitepress/dist/* ./public/docs/
                    echo "‚úÖ Copied unified docs to /docs/"
                  else
                    echo "‚ö†Ô∏è unified docs not found"
                  fi

                  # graphty-element Storybook (/storybook/element/)
                  if [ -d "./graphty-element/storybook-static" ]; then
                    mkdir -p ./public/storybook/element
                    cp -r ./graphty-element/storybook-static/* ./public/storybook/element/
                    echo "‚úÖ Copied graphty-element Storybook to /storybook/element/"
                  else
                    echo "‚ö†Ô∏è graphty-element Storybook not found"
                  fi

                  # graphty Storybook (/storybook/app/)
                  if [ -d "./graphty/storybook-static" ]; then
                    mkdir -p ./public/storybook/app
                    cp -r ./graphty/storybook-static/* ./public/storybook/app/
                    echo "‚úÖ Copied graphty Storybook to /storybook/app/"
                  else
                    echo "‚ö†Ô∏è graphty Storybook not found"
                  fi

                  # algorithms Storybook (/storybook/algorithms/)
                  if [ -d "./algorithms/storybook-static" ]; then
                    mkdir -p ./public/storybook/algorithms
                    cp -r ./algorithms/storybook-static/* ./public/storybook/algorithms/
                    echo "‚úÖ Copied algorithms Storybook to /storybook/algorithms/"
                  else
                    echo "‚ö†Ô∏è algorithms Storybook not found"
                  fi

                  # layout Storybook (/storybook/layout/)
                  if [ -d "./layout/storybook-static" ]; then
                    mkdir -p ./public/storybook/layout
                    cp -r ./layout/storybook-static/* ./public/storybook/layout/
                    echo "‚úÖ Copied layout Storybook to /storybook/layout/"
                  else
                    echo "‚ö†Ô∏è layout Storybook not found"
                  fi

                  # Create storybook index page
                  cat > ./public/storybook/index.html << 'SBINDEXEOF'
                  <!DOCTYPE html>
                  <html>
                  <head>
                    <title>Graphty Storybooks</title>
                    <style>
                      body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; }
                      h1 { color: #333; }
                      ul { list-style: none; padding: 0; }
                      li { margin: 1rem 0; }
                      a { color: #0066cc; text-decoration: none; font-size: 1.2rem; }
                      a:hover { text-decoration: underline; }
                      .desc { color: #666; font-size: 0.9rem; margin-top: 0.25rem; }
                    </style>
                  </head>
                  <body>
                    <h1>Graphty Storybooks</h1>
                    <ul>
                      <li>
                        <a href="/storybook/element/">graphty-element</a>
                        <div class="desc">Web Component library for graph visualization</div>
                      </li>
                      <li>
                        <a href="/storybook/app/">graphty app</a>
                        <div class="desc">React application components</div>
                      </li>
                      <li>
                        <a href="/storybook/algorithms/">algorithms</a>
                        <div class="desc">Interactive graph algorithm visualizations</div>
                      </li>
                      <li>
                        <a href="/storybook/layout/">layout</a>
                        <div class="desc">Graph layout algorithm demonstrations</div>
                      </li>
                    </ul>
                    <p><a href="/">‚Üê Back to graphty.app</a></p>
                  </body>
                  </html>
                  SBINDEXEOF
                  echo "‚úÖ Created storybook index at /storybook/"

                  # algorithms gh-pages (/algorithms/)
                  if [ -d "./algorithms/gh-pages" ]; then
                    cp -r ./algorithms/gh-pages ./public/algorithms
                    echo "‚úÖ Copied algorithms to /algorithms/"
                  else
                    echo "‚ö†Ô∏è algorithms gh-pages not found"
                  fi

                  # layout gh-pages (/layout/)
                  if [ -d "./layout/gh-pages" ]; then
                    cp -r ./layout/gh-pages ./public/layout
                    echo "‚úÖ Copied layout to /layout/"
                  else
                    echo "‚ö†Ô∏è layout gh-pages not found"
                  fi

                  echo ""
                  echo "üìÅ Site structure:"
                  find ./public -type f -name "*.html" | head -30

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload Pages artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./public

    deploy:
        name: Deploy
        needs: build
        runs-on: ubuntu-latest
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
