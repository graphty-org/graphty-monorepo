<!doctype html>
<html lang="en">
    <head>
        <!-- Eruda Mobile Console -->
        <script src="https://cdn.jsdelivr.net/npm/eruda@3/eruda.min.js"></script>
        <script>
            // Initialize Eruda console for mobile debugging
            if (typeof eruda !== "undefined") {
                eruda.init();
                // Auto-show on mobile devices
                if (/mobile|android|ios|iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase())) {
                    eruda.show();
                }
            }
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Closeness Centrality - Simple Visual Explanation</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }

            h1 {
                color: #2c5aa0;
                text-align: center;
            }

            .container {
                background: white;
                border-radius: 8px;
                padding: 30px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            #graph {
                width: 100%;
                height: 400px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                margin: 20px 0;
            }

            .controls {
                text-align: center;
                margin: 20px 0;
            }

            button {
                background: #4caf50;
                color: white;
                border: none;
                padding: 12px 24px;
                font-size: 16px;
                border-radius: 6px;
                cursor: pointer;
                transition: background 0.3s;
                margin: 0 5px;
            }

            button:hover {
                background: #45a049;
            }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            .explanation {
                background: #e8f0fe;
                border-left: 4px solid #2c5aa0;
                padding: 15px;
                margin: 20px 0;
                border-radius: 4px;
            }

            .step-info {
                text-align: center;
                font-size: 18px;
                color: #333;
                margin: 20px 0;
                min-height: 30px;
            }

            .legend {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin: 20px 0;
                flex-wrap: wrap;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .legend-circle {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 2px solid #333;
            }

            .closest {
                background: #ff6b6b;
            }
            .close {
                background: #4ecdc4;
            }
            .far {
                background: #96ceb4;
            }
            .measuring {
                background: #ff9800;
            }
            .target {
                background: #feca57;
            }

            .intro {
                text-align: center;
                color: #666;
                margin: 20px 0;
            }

            .centrality-display {
                background: #f0f0f0;
                padding: 15px;
                border-radius: 6px;
                margin: 20px 0;
            }

            .centrality-display h4 {
                margin: 0 0 10px 0;
                color: #666;
            }

            .node-list {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }

            .node-item {
                background: white;
                padding: 10px;
                border-radius: 4px;
                text-align: center;
                border-left: 4px solid #4caf50;
            }

            .node-item .node-name {
                font-weight: bold;
                margin-bottom: 5px;
            }

            .node-item .centrality-score {
                font-size: 12px;
                color: #666;
            }

            .back-link {
                color: #2c5aa0;
                text-decoration: none;
                margin-bottom: 20px;
                display: inline-block;
            }

            .back-link:hover {
                text-decoration: underline;
            }

            .distance-info {
                background: #f9f9f9;
                padding: 10px;
                border-radius: 6px;
                margin: 10px 0;
                text-align: center;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .code-section {
                margin-top: 30px;
            }

            .code-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .code-toggle {
                background: #666;
                color: white;
                border: none;
                padding: 5px 10px;
                font-size: 12px;
                border-radius: 4px;
                cursor: pointer;
            }

            .code-content {
                overflow: hidden;
                transition: max-height 0.3s ease;
                max-height: 1000px;
            }

            .code-content.collapsed {
                max-height: 0;
            }

            .distance-marker {
                font-size: 10px;
                font-weight: bold;
                fill: #333;
            }
        </style>
    </head>
    <body>
        <a href="../../index.html" class="back-link">← Back to Examples</a>

        <h1>Closeness Centrality Explained</h1>

        <div class="container">
            <div class="intro">
                <p>
                    <strong
                        >Closeness centrality measures how quickly a node can reach all other nodes in the
                        network.</strong
                    >
                </p>
                <p>
                    Think of it as finding the most central locations - nodes that have the shortest average distance to
                    everyone else.
                </p>
            </div>

            <svg id="graph"></svg>

            <div class="distance-info" id="distance-info">
                Click "Calculate Closeness" to measure distances from each node
            </div>

            <div class="step-info" id="step-info">Ready to find the most central nodes</div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-circle measuring"></div>
                    <span>Measuring From</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle target"></div>
                    <span>Current Target</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle closest"></div>
                    <span>Most Central</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle close"></div>
                    <span>Central</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle far"></div>
                    <span>Less Central</span>
                </div>
            </div>

            <div class="controls">
                <button id="calculate-btn" onclick="startCalculation()">Calculate Closeness</button>
                <button id="reset-btn" onclick="resetVisualization()">Reset</button>
            </div>

            <div class="centrality-display" id="centrality-display" style="display: none">
                <h4>Closeness Centrality Scores:</h4>
                <div class="node-list" id="node-list"></div>
            </div>

            <div class="explanation">
                <h3>Key Concept:</h3>
                <p>Closeness centrality identifies nodes that can quickly reach all other nodes. The algorithm:</p>
                <ul>
                    <li><strong>Measures distances:</strong> Calculates shortest path from each node to all others</li>
                    <li><strong>Central nodes:</strong> Have smaller average distances to other nodes</li>
                    <li>
                        <strong>Applications:</strong> Finding optimal locations for facilities, influential people in
                        social networks
                    </li>
                </ul>
                <p>The score is based on the inverse of the sum of distances - closer nodes get higher scores.</p>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <h3>Code Example</h3>
                    <button class="code-toggle" id="code-toggle">Hide Code ▲</button>
                </div>
                <div class="code-content" id="code-content">
                    <pre><code class="language-javascript" id="code-display">Loading code...</code></pre>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

        <script type="module">
            // Import the actual closeness centrality function
            import { runClosenessCentrality } from "./closeness.js";

            // Load and display the actual code
            async function loadCodeExample() {
                try {
                    const response = await fetch("./closeness.js");
                    const code = await response.text();

                    // Extract the main function for display
                    const functionMatch = code.match(/export function runClosenessCentrality[\s\S]*?^}/m);
                    if (functionMatch) {
                        document.getElementById("code-display").textContent = functionMatch[0];
                        Prism.highlightElement(document.getElementById("code-display"));
                    } else {
                        document.getElementById("code-display").textContent = code;
                        Prism.highlightElement(document.getElementById("code-display"));
                    }
                } catch (error) {
                    document.getElementById("code-display").textContent = `// Example usage of closeness centrality
import { closenessCentrality } from '@graphty/algorithms';

// Create a graph
const graph = createGraph();

// Calculate closeness centrality for all nodes
const centrality = closenessCentrality(graph, { normalized: true });

// Results show how "close" each node is to all others
console.log('Closeness Centrality:', centrality);`;
                    Prism.highlightElement(document.getElementById("code-display"));
                }
            }

            // Graph structure for visualization - a network with clear central nodes
            const nodes = [
                { id: "A", x: 100, y: 200 },
                { id: "B", x: 200, y: 100 },
                { id: "C", x: 300, y: 100 },
                { id: "D", x: 400, y: 200 },
                { id: "E", x: 300, y: 200 },
                { id: "F", x: 200, y: 200 },
                { id: "G", x: 250, y: 300 },
                { id: "H", x: 350, y: 300 },
                { id: "I", x: 500, y: 100 },
                { id: "J", x: 500, y: 300 },
            ];

            const edges = [
                { source: "A", target: "F" },
                { source: "B", target: "F" },
                { source: "B", target: "C" },
                { source: "C", target: "E" },
                { source: "D", target: "E" },
                { source: "E", target: "F" },
                { source: "E", target: "G" },
                { source: "E", target: "H" },
                { source: "F", target: "G" },
                { source: "H", target: "G" },
                { source: "C", target: "I" },
                { source: "D", target: "J" },
                { source: "H", target: "J" },
            ];

            let isCalculating = false;
            let centralityScores = {};

            // Initialize the graph visualization
            function initGraph() {
                const svg = document.getElementById("graph");
                svg.innerHTML = "";

                // Add edge elements
                edges.forEach((edge) => {
                    const source = nodes.find((n) => n.id === edge.source);
                    const target = nodes.find((n) => n.id === edge.target);

                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", source.x);
                    line.setAttribute("y1", source.y);
                    line.setAttribute("x2", target.x);
                    line.setAttribute("y2", target.y);
                    line.setAttribute("stroke", "#ddd");
                    line.setAttribute("stroke-width", "2");
                    line.setAttribute("id", `edge-${edge.source}-${edge.target}`);
                    svg.appendChild(line);
                });

                // Add node elements
                nodes.forEach((node) => {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");

                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", node.x);
                    circle.setAttribute("cy", node.y);
                    circle.setAttribute("r", "25");
                    circle.setAttribute("fill", "#e0e0e0");
                    circle.setAttribute("stroke", "#333");
                    circle.setAttribute("stroke-width", "2");
                    circle.setAttribute("id", `node-${node.id}`);

                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", node.x);
                    text.setAttribute("y", node.y + 5);
                    text.setAttribute("text-anchor", "middle");
                    text.setAttribute("font-weight", "bold");
                    text.textContent = node.id;

                    // Distance label (initially hidden)
                    const distanceText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    distanceText.setAttribute("x", node.x);
                    distanceText.setAttribute("y", node.y - 30);
                    distanceText.setAttribute("text-anchor", "middle");
                    distanceText.setAttribute("class", "distance-marker");
                    distanceText.setAttribute("id", `distance-${node.id}`);
                    distanceText.style.visibility = "hidden";

                    g.appendChild(circle);
                    g.appendChild(text);
                    g.appendChild(distanceText);
                    svg.appendChild(g);
                });
            }

            // Start the closeness centrality calculation
            window.startCalculation = async function () {
                if (isCalculating) return;

                isCalculating = true;
                document.getElementById("calculate-btn").disabled = true;
                document.getElementById("reset-btn").disabled = true;
                document.getElementById("centrality-display").style.display = "none";

                // Reset all nodes
                nodes.forEach((node) => {
                    document.getElementById(`node-${node.id}`).setAttribute("fill", "#e0e0e0");
                    document.getElementById(`distance-${node.id}`).style.visibility = "hidden";
                });

                // Run the actual algorithm
                const result = runClosenessCentrality();
                console.log("Closeness Centrality Result:", result);
                centralityScores = result;

                // Animate the calculation process
                await animateCalculation();

                // Display final results
                displayResults();

                isCalculating = false;
                document.getElementById("reset-btn").disabled = false;
            };

            // Animate the closeness calculation process
            async function animateCalculation() {
                const stepInfo = document.getElementById("step-info");
                const distanceInfo = document.getElementById("distance-info");

                // Simulate calculating distances from each node
                for (const sourceNode of nodes) {
                    // Highlight source node
                    document.getElementById(`node-${sourceNode.id}`).setAttribute("fill", "#ff9800");
                    stepInfo.textContent = `Measuring distances from node ${sourceNode.id}`;

                    // Show distance calculation to other nodes
                    for (const targetNode of nodes) {
                        if (sourceNode.id === targetNode.id) continue;

                        // Highlight target node
                        document.getElementById(`node-${targetNode.id}`).setAttribute("fill", "#feca57");

                        // Calculate and show distance (simplified)
                        const distance = getSimplifiedDistance(sourceNode.id, targetNode.id);
                        const distanceLabel = document.getElementById(`distance-${targetNode.id}`);
                        distanceLabel.textContent = distance.toString();
                        distanceLabel.style.visibility = "visible";

                        distanceInfo.textContent = `Distance from ${sourceNode.id} to ${targetNode.id}: ${distance} steps`;

                        await sleep(200); // Quick animation

                        // Reset target node color
                        document.getElementById(`node-${targetNode.id}`).setAttribute("fill", "#e0e0e0");
                    }

                    // Hide distance labels
                    nodes.forEach((node) => {
                        document.getElementById(`distance-${node.id}`).style.visibility = "hidden";
                    });

                    // Reset source node color
                    document.getElementById(`node-${sourceNode.id}`).setAttribute("fill", "#e0e0e0");

                    await sleep(500);
                }

                stepInfo.textContent = "Calculation complete! Nodes colored by closeness centrality.";
                distanceInfo.textContent = "Nodes with higher closeness are more central in the network.";
            }

            // Simplified distance calculation for visualization
            function getSimplifiedDistance(source, target) {
                // This is just for visualization - real algorithm uses BFS
                const distanceMap = {
                    "A-B": 2,
                    "A-C": 3,
                    "A-D": 3,
                    "A-E": 2,
                    "A-F": 1,
                    "A-G": 2,
                    "A-H": 3,
                    "A-I": 4,
                    "A-J": 4,
                    "B-A": 2,
                    "B-C": 1,
                    "B-D": 3,
                    "B-E": 2,
                    "B-F": 1,
                    "B-G": 2,
                    "B-H": 3,
                    "B-I": 2,
                    "B-J": 4,
                    "C-A": 3,
                    "C-B": 1,
                    "C-D": 2,
                    "C-E": 1,
                    "C-F": 2,
                    "C-G": 2,
                    "C-H": 2,
                    "C-I": 1,
                    "C-J": 3,
                    "D-A": 3,
                    "D-B": 3,
                    "D-C": 2,
                    "D-E": 1,
                    "D-F": 2,
                    "D-G": 2,
                    "D-H": 2,
                    "D-I": 3,
                    "D-J": 1,
                    "E-A": 2,
                    "E-B": 2,
                    "E-C": 1,
                    "E-D": 1,
                    "E-F": 1,
                    "E-G": 1,
                    "E-H": 1,
                    "E-I": 2,
                    "E-J": 2,
                    "F-A": 1,
                    "F-B": 1,
                    "F-C": 2,
                    "F-D": 2,
                    "F-E": 1,
                    "F-G": 1,
                    "F-H": 2,
                    "F-I": 3,
                    "F-J": 3,
                    "G-A": 2,
                    "G-B": 2,
                    "G-C": 2,
                    "G-D": 2,
                    "G-E": 1,
                    "G-F": 1,
                    "G-H": 1,
                    "G-I": 3,
                    "G-J": 2,
                    "H-A": 3,
                    "H-B": 3,
                    "H-C": 2,
                    "H-D": 2,
                    "H-E": 1,
                    "H-F": 2,
                    "H-G": 1,
                    "H-I": 3,
                    "H-J": 1,
                    "I-A": 4,
                    "I-B": 2,
                    "I-C": 1,
                    "I-D": 3,
                    "I-E": 2,
                    "I-F": 3,
                    "I-G": 3,
                    "I-H": 3,
                    "I-J": 4,
                    "J-A": 4,
                    "J-B": 4,
                    "J-C": 3,
                    "J-D": 1,
                    "J-E": 2,
                    "J-F": 3,
                    "J-G": 2,
                    "J-H": 1,
                    "J-I": 4,
                };

                return distanceMap[`${source}-${target}`] || 1;
            }

            // Display the final centrality results
            function displayResults() {
                const centralityDisplay = document.getElementById("centrality-display");
                const nodeList = document.getElementById("node-list");

                // Clear previous results
                nodeList.innerHTML = "";

                // Sort nodes by centrality
                const sortedNodes = Object.entries(centralityScores).sort(([, a], [, b]) => b - a);

                // Find max centrality for scaling
                const maxCentrality = Math.max(...Object.values(centralityScores));

                // Display each node's centrality
                sortedNodes.forEach(([nodeId, centrality]) => {
                    const nodeItem = document.createElement("div");
                    nodeItem.className = "node-item";

                    // Color based on centrality
                    let colorClass = "far";
                    if (centrality > maxCentrality * 0.8) {
                        colorClass = "closest";
                    } else if (centrality > maxCentrality * 0.5) {
                        colorClass = "close";
                    }

                    nodeItem.innerHTML = `
                    <div class="node-name">Node ${nodeId}</div>
                    <div class="centrality-score">Closeness: ${centrality.toFixed(4)}</div>
                `;

                    nodeList.appendChild(nodeItem);

                    // Update node color on graph
                    const nodeElement = document.getElementById(`node-${nodeId}`);
                    if (nodeElement) {
                        if (centrality > maxCentrality * 0.8) {
                            nodeElement.setAttribute("fill", "#ff6b6b");
                        } else if (centrality > maxCentrality * 0.5) {
                            nodeElement.setAttribute("fill", "#4ecdc4");
                        } else {
                            nodeElement.setAttribute("fill", "#96ceb4");
                        }
                    }
                });

                centralityDisplay.style.display = "block";
            }

            // Reset the visualization
            window.resetVisualization = function () {
                document.getElementById("calculate-btn").disabled = false;
                document.getElementById("centrality-display").style.display = "none";
                document.getElementById("step-info").textContent = "Ready to find the most central nodes";
                document.getElementById("distance-info").textContent =
                    'Click "Calculate Closeness" to measure distances from each node';

                // Reset all nodes to default color
                nodes.forEach((node) => {
                    document.getElementById(`node-${node.id}`).setAttribute("fill", "#e0e0e0");
                    document.getElementById(`distance-${node.id}`).style.visibility = "hidden";
                });
            };

            // Code toggle functionality
            document.getElementById("code-toggle").addEventListener("click", function () {
                const codeContent = document.getElementById("code-content");
                const toggle = document.getElementById("code-toggle");

                if (codeContent.classList.contains("collapsed")) {
                    codeContent.classList.remove("collapsed");
                    toggle.textContent = "Hide Code ▲";
                } else {
                    codeContent.classList.add("collapsed");
                    toggle.textContent = "Show Code ▼";
                }
            });

            // Helper sleep function
            function sleep(ms) {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }

            // Initialize on load
            window.onload = function () {
                initGraph();
                loadCodeExample();
            };
        </script>
    </body>
</html>
