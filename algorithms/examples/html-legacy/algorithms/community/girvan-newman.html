<!doctype html>
<html lang="en">
    <head>
        <!-- MANDATORY: Eruda Mobile Console (exact code) -->
        <script src="https://cdn.jsdelivr.net/npm/eruda@3/eruda.min.js"></script>
        <script>
            if (typeof eruda !== "undefined") {
                eruda.init();
                if (/mobile|android|ios|iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase())) {
                    eruda.show();
                }
            }
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Girvan-Newman Algorithm - Simple Visual Explanation</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
        <style>
            /* MANDATORY STYLES - DO NOT MODIFY */
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5; /* Light gray background */
            }

            h1 {
                color: #2c5aa0; /* Blue header */
                text-align: center;
            }

            .container {
                background: white;
                border-radius: 8px;
                padding: 30px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            #graph {
                width: 100%;
                height: 400px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                margin: 20px 0;
            }

            button {
                background: #4caf50; /* Green button */
                color: white;
                border: none;
                padding: 12px 24px;
                font-size: 16px;
                border-radius: 6px;
                cursor: pointer;
            }

            .explanation {
                background: #e8f0fe;
                border-left: 4px solid #2c5aa0;
                padding: 15px;
                margin: 20px 0;
                border-radius: 4px;
            }

            /* Additional algorithm-specific styles */
            .back-link {
                text-decoration: none;
                color: #2c5aa0;
                display: inline-block;
                margin-bottom: 20px;
                font-weight: 500;
            }

            .back-link:hover {
                text-decoration: underline;
            }

            .intro {
                margin-bottom: 20px;
            }

            .intro p {
                margin: 10px 0;
                line-height: 1.6;
            }

            .intro strong {
                color: #333;
            }

            .scenario-selector {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin: 20px 0;
            }

            .scenario-btn {
                background: #e0e0e0;
                color: #333;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }

            .scenario-btn.active {
                background: #2c5aa0;
                color: white;
            }

            .scenario-btn:hover {
                background: #2196f3;
                color: white;
            }

            .algorithm-info {
                display: flex;
                justify-content: space-around;
                margin: 20px 0;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 6px;
                flex-wrap: wrap;
            }

            .info-item {
                text-align: center;
                min-width: 120px;
            }

            .info-label {
                font-size: 14px;
                color: #666;
                margin-bottom: 5px;
            }

            .info-value {
                font-size: 18px;
                font-weight: bold;
                color: #2c5aa0;
            }

            .step-info {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                padding: 15px;
                border-radius: 6px;
                margin: 15px 0;
                font-size: 16px;
                text-align: center;
            }

            .legend {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 20px;
                margin: 15px 0;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 6px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .legend-color {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 2px solid #333;
            }

            .controls {
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
                margin: 20px 0;
            }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            .dendrogram-display {
                margin: 20px 0;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 6px;
                max-height: 200px;
                overflow-y: auto;
            }

            .dendrogram-step {
                padding: 8px;
                margin: 5px 0;
                background: white;
                border-radius: 4px;
                border-left: 4px solid #2c5aa0;
            }

            .current-step {
                background: #e8f0fe !important;
                border-left-color: #4caf50 !important;
            }

            .code-section {
                margin: 30px 0;
            }

            .code-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .code-toggle {
                background: #666;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }

            .code-content {
                background: #f8f8f8;
                border-radius: 8px;
                overflow: hidden;
            }

            #code-display {
                margin: 0;
                max-height: 400px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <a href="../../index.html" class="back-link">← Back to Examples</a>

        <h1>Girvan-Newman Algorithm Explained</h1>

        <div class="container">
            <div class="intro">
                <p><strong>Like peeling an onion layer by layer to reveal the natural groups inside!</strong></p>
                <p>
                    The Girvan-Newman algorithm finds communities by removing the most important "bridge" connections
                    between groups. It creates a hierarchy showing how communities split apart as connections are
                    removed.
                </p>
            </div>

            <div class="scenario-selector">
                <button class="scenario-btn active" onclick="selectScenario('social')">Social Network</button>
                <button class="scenario-btn" onclick="selectScenario('research')">Research Groups</button>
                <button class="scenario-btn" onclick="selectScenario('karate')">Karate Club</button>
                <button class="scenario-btn" onclick="selectScenario('departments')">Company Departments</button>
            </div>

            <svg id="graph"></svg>

            <div class="algorithm-info" id="algorithm-info">
                <div class="info-item">
                    <div class="info-label">Communities</div>
                    <div class="info-value" id="community-count">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Modularity</div>
                    <div class="info-value" id="modularity-score">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Step</div>
                    <div class="info-value" id="current-step">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Edges Removed</div>
                    <div class="info-value" id="edges-removed">0</div>
                </div>
            </div>

            <div class="step-info" id="step-info">
                Click "Start Algorithm" to see how Girvan-Newman finds communities by removing bridge edges
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e0e0e0"></div>
                    <span>Original Network</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b"></div>
                    <span>Community 1</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ecdc4"></div>
                    <span>Community 2</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #45b7d1"></div>
                    <span>Community 3</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #96ceb4"></div>
                    <span>Community 4</span>
                </div>
            </div>

            <div class="controls">
                <button id="start-btn" onclick="startAlgorithm()">Start Algorithm</button>
                <button id="step-btn" onclick="nextStep()" disabled>Next Step</button>
                <button id="best-btn" onclick="showBestPartition()" disabled>Show Best Partition</button>
                <button id="reset-btn" onclick="resetVisualization()">Reset</button>
            </div>

            <div class="dendrogram-display" id="dendrogram-display" style="display: none">
                <h4>Hierarchical Dendrogram</h4>
                <div id="dendrogram-steps"></div>
            </div>

            <div class="explanation">
                <h3>Key Concept:</h3>
                <p>
                    The Girvan-Newman algorithm works by identifying and removing edges with the highest
                    <strong>betweenness centrality</strong> - edges that lie on many shortest paths between nodes. These
                    "bridge" edges connect different communities, so removing them reveals the natural community
                    structure.
                </p>
            </div>

            <div class="code-section">
                <div class="code-header">
                    <h3>Code Example</h3>
                    <button class="code-toggle" id="code-toggle">Hide Code ▲</button>
                </div>
                <div class="code-content" id="code-content">
                    <pre><code class="language-javascript" id="code-display">Loading code...</code></pre>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

        <script type="module">
            // Import the algorithm function
            import { Graph, girvanNewman } from "./algorithms.js";

            // Load and display the actual code
            async function loadCodeExample() {
                try {
                    const response = await fetch("./girvan-newman.js");
                    const code = await response.text();
                    document.getElementById("code-display").textContent = code;
                    if (window.Prism) {
                        window.Prism.highlightAll();
                    }
                } catch (error) {
                    document.getElementById("code-display").textContent = "Error loading code example";
                }
            }

            // Community colors for visualization
            const communityColors = [
                "#ff6b6b",
                "#4ecdc4",
                "#45b7d1",
                "#96ceb4",
                "#feca57",
                "#ff9ff3",
                "#54a0ff",
                "#5f27cd",
            ];

            // Current scenario data
            let currentScenario = "social";
            let currentGraph = null;
            let dendrogram = [];
            let currentStepIndex = 0;
            let bestPartitionIndex = 0;

            // Scenario definitions
            const scenarios = {
                social: {
                    name: "Social Network",
                    description: "Friend connections in a social network with two main groups",
                    nodes: [
                        { id: "Alice", x: 100, y: 150 },
                        { id: "Bob", x: 150, y: 100 },
                        { id: "Carol", x: 200, y: 150 },
                        { id: "David", x: 150, y: 200 },
                        { id: "Eve", x: 400, y: 150 },
                        { id: "Frank", x: 450, y: 100 },
                        { id: "Grace", x: 500, y: 150 },
                        { id: "Henry", x: 450, y: 200 },
                    ],
                    edges: [
                        ["Alice", "Bob"],
                        ["Alice", "Carol"],
                        ["Bob", "Carol"],
                        ["Bob", "David"],
                        ["Carol", "David"],
                        ["Alice", "David"], // Community 1
                        ["Eve", "Frank"],
                        ["Eve", "Grace"],
                        ["Frank", "Grace"],
                        ["Frank", "Henry"],
                        ["Grace", "Henry"],
                        ["Eve", "Henry"], // Community 2
                        ["David", "Eve"], // Bridge
                    ],
                },
                research: {
                    name: "Research Groups",
                    description: "Collaboration network between AI and Biology research groups",
                    nodes: [
                        { id: "AI_Prof", x: 120, y: 150 },
                        { id: "ML_Student", x: 80, y: 100 },
                        { id: "NLP_Student", x: 160, y: 100 },
                        { id: "Vision_Student", x: 120, y: 200 },
                        { id: "Bio_Prof", x: 480, y: 150 },
                        { id: "Genetics_Student", x: 440, y: 100 },
                        { id: "Protein_Student", x: 520, y: 100 },
                        { id: "Cell_Student", x: 480, y: 200 },
                    ],
                    edges: [
                        ["AI_Prof", "ML_Student"],
                        ["AI_Prof", "NLP_Student"],
                        ["AI_Prof", "Vision_Student"],
                        ["ML_Student", "NLP_Student"],
                        ["NLP_Student", "Vision_Student"], // AI group
                        ["Bio_Prof", "Genetics_Student"],
                        ["Bio_Prof", "Protein_Student"],
                        ["Bio_Prof", "Cell_Student"],
                        ["Genetics_Student", "Protein_Student"],
                        ["Protein_Student", "Cell_Student"], // Bio group
                        ["NLP_Student", "Protein_Student"], // Collaboration bridge
                    ],
                },
                karate: {
                    name: "Karate Club",
                    description: "Famous karate club network showing faction split",
                    nodes: [
                        { id: "Instructor", x: 100, y: 150 },
                        { id: "Student1", x: 60, y: 100 },
                        { id: "Student2", x: 140, y: 100 },
                        { id: "Student3", x: 60, y: 200 },
                        { id: "Student4", x: 140, y: 200 },
                        { id: "Admin", x: 500, y: 150 },
                        { id: "Student5", x: 460, y: 100 },
                        { id: "Student6", x: 540, y: 100 },
                        { id: "Student7", x: 460, y: 200 },
                        { id: "Student8", x: 540, y: 200 },
                    ],
                    edges: [
                        ["Instructor", "Student1"],
                        ["Instructor", "Student2"],
                        ["Instructor", "Student3"],
                        ["Instructor", "Student4"],
                        ["Student1", "Student2"],
                        ["Student2", "Student3"],
                        ["Student3", "Student4"],
                        ["Student1", "Student4"], // Instructor group
                        ["Admin", "Student5"],
                        ["Admin", "Student6"],
                        ["Admin", "Student7"],
                        ["Admin", "Student8"],
                        ["Student5", "Student6"],
                        ["Student6", "Student7"],
                        ["Student7", "Student8"],
                        ["Student5", "Student8"], // Admin group
                        ["Student2", "Student6"],
                        ["Student3", "Student7"], // Weak ties causing conflict
                    ],
                },
                departments: {
                    name: "Company Departments",
                    description: "Collaboration network between Sales, Engineering, and Marketing",
                    nodes: [
                        { id: "Sales_Lead", x: 120, y: 100 },
                        { id: "Sales_Rep1", x: 80, y: 150 },
                        { id: "Sales_Rep2", x: 160, y: 150 },
                        { id: "Engineer_Lead", x: 300, y: 100 },
                        { id: "Dev1", x: 260, y: 150 },
                        { id: "Dev2", x: 340, y: 150 },
                        { id: "Marketing_Lead", x: 480, y: 100 },
                        { id: "Designer", x: 440, y: 150 },
                        { id: "Content", x: 520, y: 150 },
                    ],
                    edges: [
                        ["Sales_Lead", "Sales_Rep1"],
                        ["Sales_Lead", "Sales_Rep2"],
                        ["Sales_Rep1", "Sales_Rep2"], // Sales
                        ["Engineer_Lead", "Dev1"],
                        ["Engineer_Lead", "Dev2"],
                        ["Dev1", "Dev2"], // Engineering
                        ["Marketing_Lead", "Designer"],
                        ["Marketing_Lead", "Content"],
                        ["Designer", "Content"], // Marketing
                        ["Sales_Rep2", "Dev1"],
                        ["Dev2", "Designer"], // Cross-department collaboration
                    ],
                },
            };

            // Graph setup and visualization
            function initGraph() {
                selectScenario(currentScenario);
                loadCodeExample();
                setupCodeToggle();
            }

            function setupCodeToggle() {
                const toggle = document.getElementById("code-toggle");
                const content = document.getElementById("code-content");

                toggle.addEventListener("click", () => {
                    if (content.style.display === "none") {
                        content.style.display = "block";
                        toggle.textContent = "Hide Code ▲";
                    } else {
                        content.style.display = "none";
                        toggle.textContent = "Show Code ▼";
                    }
                });
            }

            window.selectScenario = function (scenarioKey) {
                currentScenario = scenarioKey;
                const scenario = scenarios[scenarioKey];

                // Update active button
                document.querySelectorAll(".scenario-btn").forEach((btn) => btn.classList.remove("active"));
                event?.target?.classList.add("active") ||
                    document.querySelector(`[onclick="selectScenario('${scenarioKey}')"]`).classList.add("active");

                // Create new graph
                currentGraph = new Graph();
                scenario.nodes.forEach((node) => currentGraph.addNode(node.id));
                scenario.edges.forEach(([source, target]) => currentGraph.addEdge(source, target));

                // Reset state
                dendrogram = [];
                currentStepIndex = 0;
                bestPartitionIndex = 0;

                // Update UI
                document.getElementById("step-info").textContent =
                    `Scenario: ${scenario.name} - ${scenario.description}`;
                updateInfo(0, 0.0, 0, 0);

                // Render initial graph
                drawGraph(scenario.nodes, scenario.edges, []);

                // Enable start button
                document.getElementById("start-btn").disabled = false;
                document.getElementById("step-btn").disabled = true;
                document.getElementById("best-btn").disabled = true;
                document.getElementById("dendrogram-display").style.display = "none";
            };

            function drawGraph(nodes, edges, communities = []) {
                const svg = document.getElementById("graph");
                svg.innerHTML = "";

                const width = 600;
                const height = 400;
                svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

                // Create community color mapping
                const nodeToColor = new Map();
                communities.forEach((community, index) => {
                    const color = communityColors[index % communityColors.length];
                    community.forEach((nodeId) => nodeToColor.set(nodeId, color));
                });

                // Draw edges
                edges.forEach(([source, target]) => {
                    const sourceNode = nodes.find((n) => n.id === source);
                    const targetNode = nodes.find((n) => n.id === target);
                    if (sourceNode && targetNode) {
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("x1", sourceNode.x);
                        line.setAttribute("y1", sourceNode.y);
                        line.setAttribute("x2", targetNode.x);
                        line.setAttribute("y2", targetNode.y);
                        line.setAttribute("stroke", "#999");
                        line.setAttribute("stroke-width", "2");
                        svg.appendChild(line);
                    }
                });

                // Draw nodes
                nodes.forEach((node) => {
                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", node.x);
                    circle.setAttribute("cy", node.y);
                    circle.setAttribute("r", "15");
                    circle.setAttribute("fill", nodeToColor.get(node.id) || "#e0e0e0");
                    circle.setAttribute("stroke", "#333");
                    circle.setAttribute("stroke-width", "2");
                    svg.appendChild(circle);

                    // Node label
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", node.x);
                    text.setAttribute("y", node.y + 5);
                    text.setAttribute("text-anchor", "middle");
                    text.setAttribute("font-size", "10");
                    text.setAttribute("font-weight", "bold");
                    text.setAttribute("fill", nodeToColor.get(node.id) ? "white" : "#333");
                    text.textContent = node.id.substring(0, 3);
                    svg.appendChild(text);
                });
            }

            function updateInfo(communities, modularity, step, edgesRemoved) {
                document.getElementById("community-count").textContent = communities;
                document.getElementById("modularity-score").textContent = modularity.toFixed(4);
                document.getElementById("current-step").textContent = step;
                document.getElementById("edges-removed").textContent = edgesRemoved;
            }

            function updateDendrogram() {
                const container = document.getElementById("dendrogram-steps");
                container.innerHTML = "";

                dendrogram.forEach((step, index) => {
                    const stepDiv = document.createElement("div");
                    stepDiv.className = "dendrogram-step";
                    if (index === currentStepIndex) {
                        stepDiv.classList.add("current-step");
                    }

                    stepDiv.innerHTML = `
                    <strong>Step ${index + 1}:</strong> 
                    ${step.communities.length} communities, 
                    Modularity: ${step.modularity.toFixed(4)}
                    ${index === bestPartitionIndex ? " (Best)" : ""}
                `;

                    stepDiv.addEventListener("click", () => {
                        currentStepIndex = index;
                        showStep(index);
                    });

                    container.appendChild(stepDiv);
                });
            }

            function showStep(stepIndex) {
                if (stepIndex < 0 || stepIndex >= dendrogram.length) return;

                currentStepIndex = stepIndex;
                const step = dendrogram[stepIndex];
                const scenario = scenarios[currentScenario];

                // Update visualization
                drawGraph(scenario.nodes, scenario.edges, step.communities);

                // Update info
                const edgesRemoved = stepIndex; // Each step removes one edge (simplified)
                updateInfo(step.communities.length, step.modularity, stepIndex + 1, edgesRemoved);

                // Update step info
                if (stepIndex === 0) {
                    document.getElementById("step-info").textContent =
                        "Initial state: All nodes in one large component";
                } else {
                    document.getElementById("step-info").textContent =
                        `Step ${stepIndex + 1}: Removed bridge edge(s) with highest betweenness centrality. Found ${step.communities.length} communities.`;
                }

                // Update dendrogram display
                updateDendrogram();
            }

            window.startAlgorithm = function () {
                if (!currentGraph) return;

                // Run Girvan-Newman algorithm
                console.log("Girvan-Newman Algorithm Result:");
                dendrogram = girvanNewman(currentGraph);
                console.log("Dendrogram:", dendrogram);

                // Find best partition (highest modularity)
                bestPartitionIndex = 0;
                let bestModularity = dendrogram[0]?.modularity || 0;
                dendrogram.forEach((step, index) => {
                    if (step.modularity > bestModularity) {
                        bestModularity = step.modularity;
                        bestPartitionIndex = index;
                    }
                });

                // Show initial state
                currentStepIndex = 0;
                showStep(0);

                // Update UI
                document.getElementById("start-btn").disabled = true;
                document.getElementById("step-btn").disabled = false;
                document.getElementById("best-btn").disabled = false;
                document.getElementById("dendrogram-display").style.display = "block";

                document.getElementById("step-info").textContent =
                    'Algorithm started! Use "Next Step" to see the hierarchical community detection process.';
            };

            window.nextStep = function () {
                if (currentStepIndex < dendrogram.length - 1) {
                    setTimeout(() => {
                        showStep(currentStepIndex + 1);
                    }, 1500);
                } else {
                    document.getElementById("step-info").textContent =
                        "Algorithm complete! All bridge edges have been removed.";
                    document.getElementById("step-btn").disabled = true;
                }
            };

            window.showBestPartition = function () {
                showStep(bestPartitionIndex);
                document.getElementById("step-info").textContent =
                    `Showing best partition (Step ${bestPartitionIndex + 1}) with highest modularity score of ${dendrogram[bestPartitionIndex].modularity.toFixed(4)}`;
            };

            window.resetVisualization = function () {
                selectScenario(currentScenario);
            };

            // Initialize on load
            window.onload = initGraph;
        </script>
    </body>
</html>
