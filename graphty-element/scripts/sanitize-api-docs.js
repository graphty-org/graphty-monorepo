#!/usr/bin/env node
// THIS FILE IS AUTO GENERATED: DO NOT EDIT THIS FILE.
// Post-process generated TypeDoc markdown to escape angle brackets
// that would otherwise break VitePress Vue template parsing.

import { readdir, readFile, writeFile } from "fs/promises";
import { join, extname } from "path";

const DOCS_API_DIR = "./docs/api/generated";

async function processFile(filePath) {
    const content = await readFile(filePath, "utf-8");

    // Escape angle brackets that appear outside of code blocks and backticks
    // Pattern: Match lines that have <TypeName> patterns outside of backticks
    let modified = content;

    // Split by code blocks first to avoid modifying code
    const lines = modified.split("\n");
    const processedLines = lines.map((line) => {
        // Skip lines that are inside code blocks (start with ``` or are indented code)
        if (line.startsWith("```") || line.startsWith("    ")) {
            return line;
        }

        // Skip lines that are entirely backtick-wrapped code
        if (line.match(/^`[^`]+`$/)) {
            return line;
        }

        // Find patterns like Promise<SomeType> that are not inside backticks
        // Replace < and > with their HTML entities, but only in non-code parts

        // Split by backtick sections and process only non-backtick parts
        const parts = line.split(/(`[^`]+`)/g);
        const processedParts = parts.map((part, index) => {
            // Even indices are non-backtick parts
            if (index % 2 === 0) {
                // Replace angle brackets in type annotations like Promise<Type>
                // but be careful not to affect markdown links [text](url)
                return part
                    .replace(/([A-Z][a-zA-Z0-9]*)<([A-Za-z][A-Za-z0-9\[\]., ]*?)>/g, "$1\\<$2\\>")
                    .replace(/<([A-Z][a-zA-Z0-9]*)>/g, "\\<$1\\>");
            }
            return part;
        });

        return processedParts.join("");
    });

    modified = processedLines.join("\n");

    if (modified !== content) {
        await writeFile(filePath, modified, "utf-8");
        return true;
    }
    return false;
}

async function processDirectory(dirPath) {
    const entries = await readdir(dirPath, { withFileTypes: true });
    let filesModified = 0;

    for (const entry of entries) {
        const fullPath = join(dirPath, entry.name);

        if (entry.isDirectory()) {
            filesModified += await processDirectory(fullPath);
        } else if (entry.isFile() && extname(entry.name) === ".md") {
            if (await processFile(fullPath)) {
                filesModified++;
            }
        }
    }

    return filesModified;
}

async function main() {
    console.log("Sanitizing API documentation...");
    const filesModified = await processDirectory(DOCS_API_DIR);
    console.log(`Modified ${filesModified} files.`);
}

main().catch((err) => {
    console.error(err);
    process.exit(1);
});
